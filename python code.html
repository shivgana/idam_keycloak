<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>python code</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__left">
    <div class="stackedit__toc">
      
    </div>
  </div>
  <div class="stackedit__right">
    <div class="stackedit__html">
      <pre class=" language-py"><code class="prism  language-py"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> render_template<span class="token punctuation">,</span> url_for<span class="token punctuation">,</span> redirect<span class="token punctuation">,</span> session<span class="token punctuation">,</span> request<span class="token punctuation">,</span> Response<span class="token punctuation">,</span> jsonify
<span class="token keyword">from</span> keycloak <span class="token keyword">import</span> Client

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SECRET_KEY'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"THis is SecRet"</span>
kc <span class="token operator">=</span> Client<span class="token punctuation">(</span><span class="token punctuation">)</span>

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	index<span class="token operator">=</span><span class="token string">"This is Index"</span>
	<span class="token comment"># tokens = session['tokens']</span>
	<span class="token comment"># access_token = tokens['access_token']</span>
	<span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span>index<span class="token operator">=</span>index<span class="token punctuation">)</span>

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	user<span class="token operator">=</span>session<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span>
	tokens <span class="token operator">=</span> session<span class="token punctuation">[</span><span class="token string">'tokens'</span><span class="token punctuation">]</span>
	rpt <span class="token operator">=</span> kc<span class="token punctuation">.</span>rpt<span class="token punctuation">(</span>kc<span class="token punctuation">.</span>access_token<span class="token punctuation">)</span>
	itr <span class="token operator">=</span> kc<span class="token punctuation">.</span>itrospect<span class="token punctuation">(</span>rpt<span class="token punctuation">[</span><span class="token string">'access_token'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'user.html'</span><span class="token punctuation">,</span>user<span class="token operator">=</span>user<span class="token punctuation">)</span>

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/admin'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	admin<span class="token operator">=</span><span class="token string">"This is Admin Page"</span>
	<span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'admin.html'</span><span class="token punctuation">,</span>admin<span class="token operator">=</span>admin<span class="token punctuation">)</span>

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	kc<span class="token punctuation">.</span>callback_uri <span class="token operator">=</span> <span class="token string">"http://localhost:5000/login/callback"</span>
	url<span class="token punctuation">,</span> state <span class="token operator">=</span> kc<span class="token punctuation">.</span>login<span class="token punctuation">(</span><span class="token punctuation">)</span>
	session<span class="token punctuation">[</span><span class="token string">'state'</span><span class="token punctuation">]</span> <span class="token operator">=</span> state
	<span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url<span class="token punctuation">)</span>

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/login/callback'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">login_callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">""" Authentication callback handler """</span>

    <span class="token comment"># validate state</span>
    state <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'state'</span><span class="token punctuation">,</span> <span class="token string">'unknown'</span><span class="token punctuation">)</span>
    _state <span class="token operator">=</span> session<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">'state'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> state <span class="token operator">!=</span> _state<span class="token punctuation">:</span>
        <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token string">'Invalid state'</span><span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token number">403</span><span class="token punctuation">)</span>

    <span class="token comment"># retrieve tokens</span>
    code <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">)</span>
    tokens <span class="token operator">=</span> kc<span class="token punctuation">.</span>callback<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
    session<span class="token punctuation">[</span><span class="token string">'tokens'</span><span class="token punctuation">]</span> <span class="token operator">=</span> tokens
    <span class="token comment"># retrieve userinfo</span>
    access_token <span class="token operator">=</span> tokens<span class="token punctuation">[</span><span class="token string">"access_token"</span><span class="token punctuation">]</span>
    userinfo <span class="token operator">=</span> kc<span class="token punctuation">.</span>fetch_userinfo<span class="token punctuation">(</span>access_token<span class="token punctuation">)</span>
    session<span class="token punctuation">[</span><span class="token string">"user"</span><span class="token punctuation">]</span> <span class="token operator">=</span> userinfo

    <span class="token comment"># send userinfo to user</span>
    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">"index"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/logout'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	token <span class="token operator">=</span> session<span class="token punctuation">[</span><span class="token string">'tokens'</span><span class="token punctuation">]</span>
	kc<span class="token punctuation">.</span>logout<span class="token punctuation">(</span>token<span class="token punctuation">[</span><span class="token string">'access_token'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>token<span class="token punctuation">[</span><span class="token string">'refresh_token'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	session<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">'tokens'</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/refresh'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	token <span class="token operator">=</span> session<span class="token punctuation">[</span><span class="token string">'tokens'</span><span class="token punctuation">]</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>
	refresh_token <span class="token operator">=</span> token<span class="token punctuation">[</span><span class="token string">'refresh_token'</span><span class="token punctuation">]</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span>kc<span class="token punctuation">.</span>refresh_tokens<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/idTokenJson'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">idTokenJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	tokens <span class="token operator">=</span> session<span class="token punctuation">[</span><span class="token string">'tokens'</span><span class="token punctuation">]</span>
	<span class="token comment"># print(dir(kc))</span>
	<span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span>data<span class="token operator">=</span>kc<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>tokens<span class="token punctuation">[</span><span class="token string">'id_token'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/accessTokenJson'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">accessTokenJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	tokens <span class="token operator">=</span> session<span class="token punctuation">[</span><span class="token string">'tokens'</span><span class="token punctuation">]</span>
	<span class="token comment"># access_token = tokens['access_token']</span>
	<span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span>data<span class="token operator">=</span>kc<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>tokens<span class="token punctuation">[</span><span class="token string">'id_token'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/idToken'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">idToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	tokens <span class="token operator">=</span> session<span class="token punctuation">[</span><span class="token string">'tokens'</span><span class="token punctuation">]</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span>tokens<span class="token punctuation">)</span>
	<span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span>data<span class="token operator">=</span>tokens<span class="token punctuation">[</span><span class="token string">'id_token'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/accessToken'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">accessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	tokens <span class="token operator">=</span> session<span class="token punctuation">[</span><span class="token string">'tokens'</span><span class="token punctuation">]</span>
	<span class="token comment"># print(dir(kc))</span>
	<span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span>data<span class="token operator">=</span>tokens<span class="token punctuation">[</span><span class="token string">'access_token'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/refreshToken'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">refreshToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	tokens <span class="token operator">=</span> session<span class="token punctuation">[</span><span class="token string">'tokens'</span><span class="token punctuation">]</span>
	<span class="token comment"># print(dir(kc))</span>
	<span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span>data<span class="token operator">=</span>tokens<span class="token punctuation">[</span><span class="token string">'refresh_token'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>

    </div>
  </div>
</body>

</html>
